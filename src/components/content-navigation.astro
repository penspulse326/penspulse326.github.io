---
import type { CategoryContentItem, CategoryWithContent } from '../utils/content';

interface Props {
  aAttrs?: (item: CategoryContentItem) => Record<string, boolean | string | undefined>;
  activeId?: string;
  id: string;
  navigation: CategoryWithContent[];
}

const { aAttrs, activeId, id, navigation } = Astro.props;

const sanitizeId = (value: string) => value.replace(/[^a-zA-Z0-9_-]/g, '-');
---

<div class="accordion accordion-flush" id={id}>
  {
    navigation.map((category: CategoryWithContent) => {
      const sectionId = `${id}-${sanitizeId(category.id)}`;
      const collapseId = `${sectionId}-collapse`;
      const headingId = `${sectionId}-heading`;
      const isExpanded = category.items.some((item: CategoryContentItem) => item.id === activeId);

      return (
        <div class="accordion-item">
          <h2 class="accordion-header" id={headingId}>
            <button
              aria-controls={collapseId}
              aria-expanded={isExpanded}
              class:list={{
                'accordion-button': true,
                collapsed: !isExpanded,
              }}
              data-bs-target={`#${collapseId}`}
              data-bs-toggle="collapse"
              type="button"
            >
              {category.label}
            </button>
          </h2>
          <div
            aria-labelledby={headingId}
            class:list={{
              'accordion-collapse collapse': true,
              show: isExpanded,
            }}
            id={collapseId}
          >
            <div class="accordion-body">
              <ul class="content-nav__list">
                {category.items.map((item: CategoryContentItem) => (
                  <li class="content-nav__item">
                    <a
                      class:list={['content-nav__link', { 'content-nav__link--active': item.id === activeId }]}
                      href={item.url}
                      {...(aAttrs?.(item) || {})}
                    >
                      {item.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      );
    })
  }
</div>

<script>
  // 擴展 Window 介面以包含 Bootstrap
  declare global {
    interface Window {
      bootstrap?: {
        Offcanvas: {
          getInstance: (element: HTMLElement) => {
            hide: () => void;
          } | null;
        };
      };
    }
  }

  // 處理 offcanvas 內的導航連結點擊
  function initContentNavigation() {
    const navLinks = document.querySelectorAll('.content-nav__link[data-bs-dismiss="offcanvas"]');

    navLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        const href = link.getAttribute('href');

        // 確保有有效的 href
        if (!href || href === '#') {
          return;
        }

        // 阻止預設行為，我們會手動處理導航
        e.preventDefault();

        // 找到 offcanvas 元素
        const offcanvasElement = document.getElementById('offcanvasNavbar');

        if (offcanvasElement) {
          // 檢查 Bootstrap 是否可用
          if (typeof window.bootstrap !== 'undefined' && window.bootstrap.Offcanvas) {
            // 使用 Bootstrap 的 API 關閉 offcanvas
            const bsOffcanvas = window.bootstrap.Offcanvas.getInstance(offcanvasElement);
            if (bsOffcanvas) {
              bsOffcanvas.hide();
            }

            // 在 offcanvas 關閉動畫完成後導航
            offcanvasElement.addEventListener(
              'hidden.bs.offcanvas',
              () => {
                window.location.href = href;
              },
              { once: true },
            );
          } else {
            // 如果 Bootstrap 未載入，使用簡單的方式關閉
            offcanvasElement.classList.remove('show');
            const backdrop = document.querySelector('.offcanvas-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            document.body.classList.remove('offcanvas-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // 短暫延遲後導航，讓動畫有時間執行
            setTimeout(() => {
              window.location.href = href;
            }, 150);
          }
        } else {
          // 如果找不到 offcanvas，直接導航
          window.location.href = href;
        }
      });
    });
  }

  // 頁面載入時初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initContentNavigation);
  } else {
    initContentNavigation();
  }
</script>

<style>
  /* 手風琴基礎樣式 */
  .accordion {
    --bs-accordion-color: inherit;
    --bs-accordion-bg: transparent;
    --bs-accordion-border-color: transparent;
  }

  .accordion-item {
    border: none;
    border-radius: 0;
    font-size: 0.9rem;
  }

  .accordion-button {
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 8px 0;
    background-color: transparent;
    box-shadow: none;
    border: none;
    border-bottom: 1px solid var(--bs-border-color);
    border-radius: 0;
    font-size: 0.9rem;
  }

  .accordion-button::after {
    margin-left: auto;
  }

  .accordion-button:not(.collapsed) {
    color: inherit;
    background-color: transparent;
  }

  .accordion-body {
    padding: 0.5rem 0 0;
  }

  /* 內容導覽列表樣式 */
  .content-nav__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  .content-nav__item {
    border-radius: 0;
  }

  .content-nav__item:last-child {
    border-bottom: none;
    margin-bottom: 12px;
  }

  .content-nav__link {
    display: flex;
    flex-direction: column;
    padding: 0.25rem 0.75rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease-in-out;
  }

  .content-nav__link:hover {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
  }

  .content-nav__link--active {
    font-weight: 600;
    color: var(--bs-primary);
    background-color: var(--bs-primary-bg-subtle);
  }
</style>
