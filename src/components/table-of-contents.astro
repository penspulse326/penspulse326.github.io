---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
  variant?: 'both' | 'desktop' | 'mobile';
}

const { headings, variant = 'both' } = Astro.props;

// 僅顯示 h2 和 h3 標題
const tocHeadings = headings.filter((h) => h.depth <= 3);
const showDesktop = variant === 'desktop' || variant === 'both';
const showMobile = variant === 'mobile' || variant === 'both';
---

{/* 桌面版目錄 - 固定在右側 */}
{
  showDesktop && (
    <aside class="toc-desktop d-none d-lg-block">
      <nav aria-label="目錄">
        <h2 class="toc-title">目錄</h2>
        <ul class="toc-list">
          {tocHeadings.map((heading) => (
            <li class:list={['toc-item', `toc-item--depth-${heading.depth}`]}>
              <a class="toc-link" href={`#${heading.slug}`}>
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}

{/* 手機版目錄（預設展開）*/}
{
  showMobile && (
    <div class="toc-mobile d-lg-none mb-4">
      <div class="accordion" id="toc-accordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="toc-heading">
            <button
              aria-controls="toc-collapse"
              aria-expanded="true"
              class="accordion-button p-2"
              data-bs-target="#toc-collapse"
              data-bs-toggle="collapse"
              type="button"
            >
              <i class="bi bi-list-ul me-2" />
              目錄
            </button>
          </h2>
          <div aria-labelledby="toc-heading" class="accordion-collapse collapse show" id="toc-collapse">
            <div class="accordion-body px-2">
              <ul class="toc-list">
                {tocHeadings.map((heading) => (
                  <li class:list={['toc-item', `toc-item--depth-${heading.depth}`]}>
                    <a class="toc-link" href={`#${heading.slug}`}>
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

<script>
  // 初始化目錄功能
  function initTOC() {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');

          if (!id) {
            return;
          }

          const tocLinks = document.querySelectorAll(`a[href="#${id}"]`);

          if (entry.isIntersecting) {
            // 移除所有連結的 active class
            document.querySelectorAll('.toc-link.active').forEach((link) => {
              link.classList.remove('active');
            });

            // 為當前連結加上 active class
            tocLinks.forEach((link) => {
              link.classList.add('active');
            });
          }
        });
      },
      {
        rootMargin: '-80px 0px -80% 0px',
        threshold: 0,
      },
    );

    // 監聽所有標題
    document.querySelectorAll('.markdown-body h2, .markdown-body h3').forEach((heading) => {
      observer.observe(heading);
    });

    // 目錄連結平滑捲動
    document.querySelectorAll('.toc-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();

        const targetId = link.getAttribute('href')?.slice(1);

        if (!targetId) {
          return;
        }

        const targetElement = document.getElementById(targetId);

        if (!targetElement) {
          return;
        }

        const offset = 80; // 固定導覽列高度
        const elementPosition = targetElement.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.scrollY - offset;

        window.scrollTo({
          behavior: 'smooth',
          top: offsetPosition,
        });

        // 更新 URL 但不跳轉
        history.pushState(null, '', `#${targetId}`);
      });
    });
  }

  // 頁面載入時初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTOC);
  } else {
    initTOC();
  }
</script>

<style>
  /* 桌面版目錄樣式 */
  .toc-desktop {
    background-color: var(--bs-body-bg);
    border-bottom: 1px solid var(--bs-border-color);
  }

  /* 目錄標題樣式 */
  .toc-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--bs-body-color);
  }

  /* 目錄列表樣式 */
  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.875rem;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-item--depth-2 {
    padding-left: 0;
  }

  .toc-item--depth-3 {
    padding-left: 1rem;
    font-size: 0.9rem;
  }

  /* 目錄連結樣式 */
  .toc-link {
    display: block;
    color: var(--bs-secondary-color);
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-left: 2px solid transparent;
    transition: all 0.2s ease;
    line-height: 1.4;
  }

  .toc-link:hover {
    color: var(--bs-primary);
    border-left-color: var(--bs-primary);
    background-color: var(--bs-primary-bg-subtle);
  }

  .toc-link.active {
    color: var(--bs-primary);
    border-left-color: var(--bs-primary);
    font-weight: 600;
  }

  /* 手機版目錄樣式 */
  .toc-mobile .accordion {
    --bs-accordion-border-color: var(--bs-border-color);
    --bs-accordion-bg: var(--bs-body-bg);
  }

  .toc-mobile .accordion-button {
    font-weight: 600;
    font-size: 1rem;
    padding: 0.875rem 1rem;
  }

  .toc-mobile .accordion-button:not(.collapsed) {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
  }

  .toc-mobile .accordion-body {
    padding: 1rem;
  }

  .toc-mobile .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-mobile .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-mobile .toc-item--depth-2 {
    padding-left: 0;
  }

  .toc-mobile .toc-item--depth-3 {
    padding-left: 1rem;
    font-size: 0.9rem;
  }

  .toc-mobile .toc-link {
    display: block;
    color: var(--bs-body-color);
    text-decoration: none;
    padding: 0.375rem 0.5rem;
    transition: all 0.2s ease;
  }

  .toc-mobile .toc-link:hover {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
  }

  .toc-mobile .toc-link.active {
    background-color: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    font-weight: 600;
  }
</style>
