---
import type { GetStaticPaths, Page } from 'astro';

import PostExcerpt from '../../../components/post-excerpt.astro';
import PostsSidebar from '../../../components/posts-sidebar.astro';
import ArticleLayout from '../../../layouts/article-layout.astro';
import { getPostsSortedByDate, getRecentPosts, getTagCloud, getAllTags, type PostEntry } from '../../../utils/posts';

export const getStaticPaths = (async () => {
  const allPosts = getPostsSortedByDate();
  const tags = Array.from(getAllTags().keys());
  const paths: Array<{ params: { tag: string }; props: { tag: string } }> = [];

  // 為每個標籤生成路徑
  for (const tag of tags) {
    const filteredPosts = allPosts.filter((post) => post.frontmatter.tags?.some((t) => t === tag));

    if (filteredPosts.length > 0) {
      paths.push({
        params: { tag },
        props: { tag },
      });
    }
  }

  return paths;
}) satisfies GetStaticPaths;

interface Props {
  tag: string;
}

const { tag } = Astro.props;

const allPosts = getPostsSortedByDate();
const filteredPosts = allPosts.filter((post) => post.frontmatter.tags?.some((t) => t === tag));

const pageSize = 5;
const totalPages = Math.ceil(filteredPosts.length / pageSize);

// 模擬第一頁的 page 物件
const page: Page<PostEntry> = {
  data: filteredPosts.slice(0, pageSize),
  start: 0,
  end: Math.min(pageSize - 1, filteredPosts.length - 1),
  size: pageSize,
  total: filteredPosts.length,
  currentPage: 1,
  lastPage: totalPages,
  url: {
    current: `/posts/tag/${encodeURIComponent(tag)}`,
    prev: undefined,
    next: totalPages > 1 ? `/posts/tag/${encodeURIComponent(tag)}/2` : undefined,
    first: undefined,
    last: totalPages > 1 ? `/posts/tag/${encodeURIComponent(tag)}/${totalPages}` : undefined,
  },
};

// 側邊欄資料
const recentPosts = getRecentPosts(5);
const tagCloud = getTagCloud();

// 格式化日期
function formatDate(date?: Date): string {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}`;
}
---

<ArticleLayout description={`標籤「${tag}」相關的心得文章`} showToc={false} title={`標籤：${tag}`}>
  <PostsSidebar recentPosts={recentPosts} slot="sidebar" tagCloud={tagCloud} />

  <div class="mx-n3">
    <div class="px-2 px-lg-4">
      <!-- 標籤標題 -->
      <div class="mb-4">
        <h2 class="h5 mb-2">標籤：{tag}</h2>
        <p class="text-muted">共 {filteredPosts.length} 篇文章</p>
      </div>

      <!-- 文章列表 -->
      <div class="posts-list">
        {
          page.data.map((post) => {
            const { Content } = post;

            return (
              <article class="post-item border-bottom rounded-0 p-3">
                <h2 class="h4 mb-3">
                  <a class="text-decoration-none text-body" href={post.url}>
                    {post.frontmatter.title}
                  </a>
                </h2>

                {post.frontmatter.date && (
                  <div class="post-meta text-muted mb-3">
                    <small>
                      {formatDate(post.frontmatter.date)} 發布
                      {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
                        <span class="ms-3">
                          <i class="bi bi-tags" />{' '}
                          {post.frontmatter.tags.map((postTag: string, idx: number) => (
                            <>
                              <a
                                class="text-muted text-decoration-none"
                                href={`/posts/tag/${encodeURIComponent(postTag)}`}
                              >
                                {postTag}
                              </a>
                              {idx < (post.frontmatter.tags?.length ?? 0) - 1 && ', '}
                            </>
                          ))}
                        </span>
                      )}
                    </small>
                  </div>
                )}

                <div class="post-content mb-3">
                  <PostExcerpt Content={Content} />
                </div>

                <a class="read-more-link" href={post.url}>
                  閱讀更多 <i class="bi bi-arrow-right" />
                </a>
              </article>
            );
          })
        }
      </div>

      <!-- 分頁 -->
      {
        page.lastPage > 1 && (
          <nav aria-label="文章分頁">
            <ul class="pagination justify-content-center">
              <li class:list={['page-item', { disabled: !page.url.prev }]}>
                <a aria-label="上一頁" class="page-link" href={page.url.prev || '#'}>
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>

              {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
                <li class:list={['page-item', { active: pageNum === page.currentPage }]}>
                  <a
                    class="page-link"
                    href={
                      pageNum === 1
                        ? `/posts/tag/${encodeURIComponent(tag)}`
                        : `/posts/tag/${encodeURIComponent(tag)}/${pageNum}`
                    }
                  >
                    {pageNum}
                  </a>
                </li>
              ))}

              <li class:list={['page-item', { disabled: !page.url.next }]}>
                <a aria-label="下一頁" class="page-link" href={page.url.next || '#'}>
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        )
      }
    </div>
  </div>
</ArticleLayout>

<style>
  /* 文章項目樣式 */
  .post-item {
    transition: 0.2s;
  }

  .post-item:hover {
    background-color: rgb(var(--bs-primary-rgb), 0.1);
  }

  .post-item .card-title a {
    color: inherit;
    transition: color 0.2s;
  }

  .post-item .card-title a:hover {
    color: var(--bs-primary);
  }

  /* 文章內容樣式 */
  .post-content {
    color: var(--bs-body-color);
    line-height: 1.6;
  }

  .post-content :global(h2),
  .post-content :global(h3) {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  .post-content :global(p) {
    margin-bottom: 0.75rem;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: 0.75rem;
    padding-left: 1.5rem;
  }

  /* 閱讀更多連結 */
  .read-more-link {
    color: var(--bs-link-color);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .read-more-link:hover {
    color: var(--bs-link-hover-color);
    text-decoration: underline;
  }

  /* 分頁樣式 */
  .pagination {
    margin-top: 2rem;
  }
</style>
