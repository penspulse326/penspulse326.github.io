---
import type { GetStaticPaths, Page } from 'astro';

import PostExcerpt from '../../components/post-excerpt.astro';
import PostsSidebar from '../../components/posts-sidebar.astro';
import ArticleLayout from '../../layouts/article-layout.astro';
import { getPostsSortedByDate, getRecentPosts, getTagCloud, type PostEntry } from '../../utils/posts';

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = getPostsSortedByDate();
  return paginate(allPosts, { pageSize: 5 });
}) satisfies GetStaticPaths;

interface Props {
  page: Page<PostEntry>;
}

const { page } = Astro.props;

// 側邊欄資料
const recentPosts = getRecentPosts(5);
const tagCloud = getTagCloud();

// 格式化日期
function formatDate(date?: Date): string {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}`;
}
---

<ArticleLayout description="與職涯、工作、活動等相關的心得文章" showToc={false} title="心得文章">
  <PostsSidebar recentPosts={recentPosts} slot="sidebar" tagCloud={tagCloud} />

  <div class="mx-n3">
    <div class="px-2 px-lg-4">
      <!-- 文章列表 -->
      <div class="posts-list">
        {
          page.data.map((post) => {
            const { Content } = post;

            return (
              <article class="post-item border-bottom rounded-0 p-3">
                <h2 class="h4 mb-3">
                  <a class="text-decoration-none text-body" href={post.url}>
                    {post.frontmatter.title}
                  </a>
                </h2>

                {post.frontmatter.date && (
                  <div class="post-meta text-muted mb-3">
                    <small>
                      {formatDate(post.frontmatter.date)} 發布
                      {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
                        <span class="ms-3">
                          <i class="bi bi-tags" />{' '}
                          {post.frontmatter.tags.map((tag: string, idx: number) => (
                            <>
                              <a class="text-muted text-decoration-none" href={`/posts?tag=${encodeURIComponent(tag)}`}>
                                {tag}
                              </a>
                              {idx < (post.frontmatter.tags?.length ?? 0) - 1 && ', '}
                            </>
                          ))}
                        </span>
                      )}
                    </small>
                  </div>
                )}

                <div class="post-content mb-3">
                  <PostExcerpt Content={Content} />
                </div>

                <a class="btn btn-outline-dark btn-sm" href={post.url}>
                  閱讀更多 <i class="bi bi-arrow-right" />
                </a>
              </article>
            );
          })
        }
      </div>

      <!-- 分頁 -->
      {
        page.lastPage > 1 && (
          <nav aria-label="文章分頁">
            <ul class="pagination justify-content-center">
              <li class:list={['page-item', { disabled: !page.url.prev }]}>
                <a aria-label="上一頁" class="page-link" href={page.url.prev || '#'}>
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>

              {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
                <li class:list={['page-item', { active: pageNum === page.currentPage }]}>
                  <a class="page-link" href={pageNum === 1 ? '/posts' : `/posts/${pageNum}`}>
                    {pageNum}
                  </a>
                </li>
              ))}

              <li class:list={['page-item', { disabled: !page.url.next }]}>
                <a aria-label="下一頁" class="page-link" href={page.url.next || '#'}>
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        )
      }
    </div>
  </div>
</ArticleLayout>

<style>
  /* 文章項目樣式 */
  .post-item {
    transition: 0.2s;
  }

  .post-item:hover {
    background-color: rgb(var(--bs-primary-rgb), 0.1);
  }

  .post-item .card-title a {
    color: inherit;
    transition: color 0.2s;
  }

  .post-item .card-title a:hover {
    color: var(--bs-primary);
  }

  /* 文章內容樣式 */
  .post-content {
    color: var(--bs-body-color);
    line-height: 1.6;
  }

  .post-content :global(h2),
  .post-content :global(h3) {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  .post-content :global(p) {
    margin-bottom: 0.75rem;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: 0.75rem;
    padding-left: 1.5rem;
  }

  /* 分頁樣式 */
  .pagination {
    margin-top: 2rem;
  }
</style>
